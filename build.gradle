/**
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/7.6/samples
 */
 plugins { 
    // https://gradle-ssh-plugin.github.io/docs/
    id 'org.hidetake.ssh' version '2.11.2'

    // https://github.com/diffplug/spotless/tree/main/plugin-gradle
    id("com.diffplug.spotless") version "6.25.0"
}

repositories {
    mavenCentral()
    gradlePluginPortal()
}

apply from: 'src/gradle/services.gradle'

spotless {
    
    // https://github.com/diffplug/spotless/issues/1795
    // TODO https://github.com/google/yamlfmt
    // yaml {
    //     target '**/*.yml'
    //     jackson()
    //     prettier()
    //     indentWithSpaces()
    // }

    groovyGradle {
        target '*.gradle','src/gradle/*.gradle'
        greclipse()
        indentWithSpaces()
    }
}

remotes {
    desktop {
        host = 'tec-desktop'
        user = 'ansible'
        // needs to be open ssh format and chmod 600
        // need to have entry in authorized hosts
        // https://gradle-ssh-plugin.github.io/docs/#__code_identity_code_public_key_authentication
        identity = file("$project.gradle.gradleUserHomeDir/ansible.pem")
    }
}

tasks.register('resetHost') {
    description = 'reset known host for tec-test'
    group = "hosts"
    doLast {
        exec {
            workingDir '.'
            commandLine 'bash', '-c',
                    "ssh-keygen -R tec-desktop"
        }
        exec {
            workingDir '.'
            commandLine 'bash', '-c',
                    "ssh-keyscan -T 30 -H tec-desktop >> ~/.ssh/known_hosts"
        }
    }
}

task dockerNet {
    description = 'created shared docker network needs to run once'
    group = "docker stuff"
    doLast {
        ssh.run {
            session(remotes.desktop) {
                def result = execute 'sudo docker network create --driver bridge share-net'
                println result
            }
        }
    }
}

// set access for deployer user
// https://unix.stackexchange.com/questions/195466/setting-multiple-groups-as-directory-owners
tasks.register ('initAcl') {
    description = 'set access for ansible user'
    group = "deploy stuff"

    doLast {
        ssh.run {
            session(remotes.desktop) {
                def result = execute 'sudo mkdir -p /mnt/raid/services'
                println result
            }
            session(remotes.desktop) {
                def result = execute 'sudo setfacl -m g:ansible:rwx /mnt/raid/services'
                println result
            }
            session(remotes.desktop) {
                def result = execute 'find  /mnt/raid/services -maxdepth 1 -type d \\( ! -iname ".*" \\) -exec sudo setfacl -m g:ansible:rwx {} \\;'
                println result
            }
            session(remotes.desktop) {
                def result = execute 'find  /mnt/raid/services -maxdepth 2 -type f \\( ! -iname "*.yml" \\) -exec sudo setfacl -m g:ansible:rw {} \\;'
                println result
            }
        }
    }
}

tasks.register('deployScripts') {
    description = 'deploy scripts to tec-desktop'
    group = "deploy stuff"

    doLast {
        ssh.run {
            session(remotes.desktop) {
                def result = execute 'sudo mkdir -p /mnt/raid/bin'
                println result
            }
            session(remotes.desktop) {
                def result = execute 'sudo chmod 777 /mnt/raid/bin'
                println result
            }
            // https://stackoverflow.com/questions/34749398/gradle-ssh-plugin-copying-parent-folder-and-not-just-files
            session(remotes.desktop) {
                put from: Arrays.asList(new File("${project.rootDir}/src/bin").listFiles()), into: '/mnt/raid/bin'
            }
            session(remotes.desktop) {
                def result = execute 'find  /mnt/raid/bin -name *.sh -type f -exec sudo chmod 755 {} \\;'
                println result
            }
        }
    }
}

tasks.register('dockerBuild') {
    description = 'build docker util container'
    group = "container build stuff"
    doLast {
        exec {
            workingDir '.'
            environment DOCKER_BUILDKIT: "1"
            // chmod requires buildkit
            // https://docs.docker.com/build/buildkit/#getting-started
            commandLine 'docker', 'build', '-f', 'src/docker/Dockerfile',  '-t', 'tec/util', '.', '--no-cache'
        }
    }
}